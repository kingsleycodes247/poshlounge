{% extends 'base.html' %}
{% load static %}

{% block title %}{% if edit_user %}Edit{% else %}Create{% endif %} User - Posh Lounge{% endblock %}
{% block page_subtitle %}User Management{% endblock %}

{% block content %}
<div class="py-6">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-6">
            <a href="{% url 'dashboard:user_list' %}" class="inline-flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900 mb-4">
                <i data-lucide="arrow-left" class="h-4 w-4"></i>
                Back to Users
            </a>
            <h1 class="text-3xl font-bold text-gray-900">
                {% if edit_user %}Edit User{% else %}Create New User{% endif %}
            </h1>
            <p class="mt-1 text-sm text-gray-500">
                {% if edit_user %}Update user information and permissions{% else %}Add a new staff member to the system{% endif %}
            </p>
        </div>

        <form method="POST" class="space-y-6">
            {% csrf_token %}
            
            <!-- Account Information Card -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4">
                    <h2 class="text-lg font-medium text-white flex items-center gap-2">
                        <i data-lucide="user" class="h-5 w-5"></i>
                        Account Information
                    </h2>
                </div>
                <div class="p-6 space-y-6">
                    <!-- Username -->
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-2">
                            Username <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="at-sign" class="h-5 w-5 text-gray-400"></i>
                            </div>
                            <input type="text" 
                                   name="username" 
                                   id="username"
                                   value="{% if edit_user %}{{ edit_user.username }}{% endif %}"
                                   required
                                   {% if edit_user %}readonly{% endif %}
                                   class="block w-full pl-10 pr-3 py-3 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 {% if edit_user %}bg-gray-50{% endif %}"
                                   placeholder="e.g., john_doe">
                        </div>
                        {% if edit_user %}
                        <p class="mt-1 text-xs text-gray-500">Username cannot be changed after creation</p>
                        {% endif %}
                    </div>

                    <!-- Password -->
                    {% if not edit_user %}
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
                            Password <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="lock" class="h-5 w-5 text-gray-400"></i>
                            </div>
                            <input type="password" 
                                   name="password" 
                                   id="password"
                                   required
                                   class="block w-full pl-10 pr-3 py-3 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                                   placeholder="Enter secure password">
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Minimum 8 characters recommended</p>
                    </div>
                    {% else %}
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-start gap-3">
                            <i data-lucide="info" class="h-5 w-5 text-blue-600 mt-0.5"></i>
                            <div>
                                <p class="text-sm font-medium text-blue-900">Password Reset</p>
                                <p class="text-sm text-blue-700 mt-1">
                                    To change the password, use Django Admin or create a new user.
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Role & Permissions Card -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <div class="bg-gradient-to-r from-purple-600 to-pink-600 px-6 py-4">
                    <h2 class="text-lg font-medium text-white flex items-center gap-2">
                        <i data-lucide="shield" class="h-5 w-5"></i>
                        Role & Permissions
                    </h2>
                </div>
                <div class="p-6">
                    <label for="role" class="block text-sm font-medium text-gray-700 mb-3">
                        User Role <span class="text-red-500">*</span>
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Admin Role -->
                        <label class="relative flex items-start p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors {% if edit_user.role == 'admin' or not edit_user %}border-purple-500 bg-purple-50{% else %}border-gray-200{% endif %}">
                            <input type="radio" 
                                   name="role" 
                                   value="admin"
                                   {% if edit_user.role == 'admin' or not edit_user %}checked{% endif %}
                                   required
                                   class="mt-1 h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300">
                            <div class="ml-3 flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <i data-lucide="shield-check" class="h-5 w-5 text-purple-600"></i>
                                    <span class="font-medium text-gray-900">Administrator</span>
                                </div>
                                <p class="text-xs text-gray-600">Full system access, reports, settings</p>
                            </div>
                        </label>

                        <!-- Waiter Role -->
                        <label class="relative flex items-start p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors {% if edit_user.role == 'waiter' %}border-blue-500 bg-blue-50{% else %}border-gray-200{% endif %}">
                            <input type="radio" 
                                   name="role" 
                                   value="waiter"
                                   {% if edit_user.role == 'waiter' %}checked{% endif %}
                                   class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                            <div class="ml-3 flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <i data-lucide="clipboard-list" class="h-5 w-5 text-blue-600"></i>
                                    <span class="font-medium text-gray-900">Waiter</span>
                                </div>
                                <p class="text-xs text-gray-600">Take orders, manage tables</p>
                            </div>
                        </label>

                        <!-- Cashier Role -->
                        <label class="relative flex items-start p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors {% if edit_user.role == 'cashier' %}border-green-500 bg-green-50{% else %}border-gray-200{% endif %}">
                            <input type="radio" 
                                   name="role" 
                                   value="cashier"
                                   {% if edit_user.role == 'cashier' %}checked{% endif %}
                                   class="mt-1 h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300">
                            <div class="ml-3 flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <i data-lucide="credit-card" class="h-5 w-5 text-green-600"></i>
                                    <span class="font-medium text-gray-900">Cashier</span>
                                </div>
                                <p class="text-xs text-gray-600">Process payments, manage shifts</p>
                            </div>
                        </label>

                        <!-- Kitchen Role -->
                        <label class="relative flex items-start p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors {% if edit_user.role == 'kitchen' %}border-orange-500 bg-orange-50{% else %}border-gray-200{% endif %}">
                            <input type="radio" 
                                   name="role" 
                                   value="kitchen"
                                   {% if edit_user.role == 'kitchen' %}checked{% endif %}
                                   class="mt-1 h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300">
                            <div class="ml-3 flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <i data-lucide="chef-hat" class="h-5 w-5 text-orange-600"></i>
                                    <span class="font-medium text-gray-900">Kitchen Staff</span>
                                </div>
                                <p class="text-xs text-gray-600">View orders, confirm items</p>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Quick Access Card -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-cyan-600 px-6 py-4">
                    <h2 class="text-lg font-medium text-white flex items-center gap-2">
                        <i data-lucide="key" class="h-5 w-5"></i>
                        Quick Access (Optional)
                    </h2>
                </div>
                <div class="p-6">
                    <label for="pin_code" class="block text-sm font-medium text-gray-700 mb-2">
                        PIN Code
                    </label>
                    <input type="text" 
                           name="pin_code" 
                           id="pin_code"
                           value="{% if edit_user %}{{ edit_user.pin_code }}{% endif %}"
                           maxlength="6"
                           pattern="[0-9]{4,6}"
                           class="block w-full px-4 py-3 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-center text-2xl font-mono tracking-widest"
                           placeholder="••••••">
                    <p class="mt-2 text-xs text-gray-500">
                        <i data-lucide="info" class="h-3 w-3 inline"></i>
                        4-6 digit PIN for faster login (numbers only)
                    </p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center justify-between gap-4 bg-white shadow-lg rounded-lg p-6">
                <a href="{% url 'dashboard:user_list' %}" 
                   class="inline-flex items-center gap-2 rounded-md border border-gray-300 bg-white px-6 py-3 text-sm font-medium text-gray-700 hover:bg-gray-50">
                    <i data-lucide="x" class="h-5 w-5"></i>
                    Cancel
                </a>
                <button type="submit" 
                        class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-8 py-3 text-sm font-medium text-white hover:bg-indigo-700 shadow-md">
                    <i data-lucide="save" class="h-5 w-5"></i>
                    {% if edit_user %}Update User{% else %}Create User{% endif %}
                </button>
            </div>
        </form>

        <!-- Device Binding Info (Edit Mode) -->
        {% if edit_user and edit_user.device_id %}
        <div class="mt-6 bg-white shadow-lg rounded-lg p-6">
            <h3 class="text-sm font-medium text-gray-900 mb-3 flex items-center gap-2">
                <i data-lucide="smartphone" class="h-4 w-4"></i>
                Device Binding
            </h3>
            <div class="p-4 bg-gray-50 rounded-lg">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-500">Device ID:</span>
                        <span class="font-mono font-medium text-gray-900 ml-2">{{ edit_user.device_id|slice:":8" }}...</span>
                    </div>
                    <div>
                        <span class="text-gray-500">Status:</span>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 ml-2">
                            <i data-lucide="check" class="h-3 w-3 mr-1"></i>
                            Bound
                        </span>
                    </div>
                </div>
                <p class="mt-3 text-xs text-gray-600">
                    <i data-lucide="info" class="h-3 w-3 inline"></i>
                    This user is bound to a specific device for security. To unbind, contact system administrator.
                </p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    lucide.createIcons();
    
    // PIN validation - only numbers
    const pinInput = document.getElementById('pin_code');
    if (pinInput) {
        pinInput.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    }
</script>
{% endblock %}